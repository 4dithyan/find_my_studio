{% load static %}
{% include 'Studio/header.html' %}

<section class="site-section" id="section-about">
    <div class="container">
        <div class="row justify-content-center">

            {% if r|length == 0 %}
                <div class="col-12 text-center">
                    <p class="alert alert-info">No requests are available at the moment.</p>
                </div>
            {% else %}
                <!-- Loop through the requests and display each as a card -->
                {% for request in r %}
                    <div class="col-md-4 mb-4"> <!-- col-md-4 gives 3 cards per row on medium screens and above -->
                        <div class="card p-3 border-0 shadow-lg rounded">
                            <!-- Card Title -->
                            <h5 class="card-title text-center mb-3 text-dark">Request ID: {{ request.requestid }}</h5>

                            <!-- Card Body -->
                            <div class="card-body">
                                <p class="card-text"><strong>Package:</strong> {{ request.packageid.packagename }}</p>
                                <p class="card-text"><strong>Required Date:</strong> {{ request.requireddate }}</p>
                                <p class="card-text"><strong>Number of Days:</strong> {{ request.noofdays }}</p>
                                <p class="card-text"><strong>Description:</strong> {{ request.description }}</p>
                                <p class="card-text"><strong>Status:</strong> {{ request.status }}</p>
                                <p class="card-text"><strong>Customer Name:</strong> {{ request.customerid.customername }}</p>
                            </div>

                            <!-- Accept and Reject Buttons -->
                            <div class="mt-3 d-flex justify-content-center gap-2">
                                <form method="POST" action="{% url 'accept_request' request.requestid %}" id="accept-form-{{ request.requestid }}">
                                    {% csrf_token %}
                                    <button type="button" class="btn btn-success btn-sm mx-2" onclick="showAdditionalCharge({{ request.requestid }})">Accept</button>
                                </form>
                                <button type="button" class="btn btn-danger btn-sm mx-2" onclick="showRejectRemark({{ request.requestid }})">Reject</button>
                            </div>

                            <!-- Reject Remark Section (Initially Hidden) -->
                            <div id="reject-remark-{{ request.requestid }}" class="reject-remark" style="display: none; margin-top: 10px;">
                                <input type="text" name="remark" id="remark-{{ request.requestid }}" class="form-control" placeholder="Enter remark">
                                <button type="button" class="btn btn-danger btn-sm mt-2" onclick="rejectRequest({{ request.requestid }})">Reject Now</button>
                            </div>

                            <!-- Additional Charge Section (Initially Hidden) -->
                            <div id="additional-charge-{{ request.requestid }}" class="additional-charge" style="display: none; margin-top: 10px;">
                                <input type="number" id="additional-charge-input-{{ request.requestid }}" class="form-control" placeholder="Enter additional charge" min="0" step="0.01">
                                <button type="button" class="btn btn-success btn-sm mt-2" onclick="acceptRequestWithCharge({{ request.requestid }})">Accept Now</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
</section>

<!-- Add JavaScript to show the remark box and handle the rejection -->
<script>
    // Show the remark input and Reject Now button when Reject is clicked
    function showRejectRemark(requestId) {
        // Hide all other reject sections and show the selected one
        const allRejectSections = document.querySelectorAll('.reject-remark');
        allRejectSections.forEach(section => section.style.display = 'none');

        const remarkSection = document.getElementById('reject-remark-' + requestId);
        remarkSection.style.display = 'block';

        // Hide the additional charge section if it's visible
        const allChargeSections = document.querySelectorAll('.additional-charge');
        allChargeSections.forEach(section => section.style.display = 'none');
    }

    // Show the additional charge input and Accept Now button when Accept is clicked
    function showAdditionalCharge(requestId) {
        // Hide all other charge sections and show the selected one
        const allChargeSections = document.querySelectorAll('.additional-charge');
        allChargeSections.forEach(section => section.style.display = 'none');

        const chargeSection = document.getElementById('additional-charge-' + requestId);
        chargeSection.style.display = 'block';

        // Hide the reject section if it's visible
        const allRejectSections = document.querySelectorAll('.reject-remark');
        allRejectSections.forEach(section => section.style.display = 'none');
    }

    // Submit the rejection along with the remark
    function rejectRequest(requestId) {
        const remarkText = document.getElementById('remark-' + requestId).value;

        if (remarkText.trim() === '') {
            alert('Please enter a remark before rejecting.');
            return;
        }

        // Confirm rejection
        if (confirm('Are you sure you want to reject this request?')) {
            // Create a form dynamically to submit the rejection with the remark
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "reject_request" 0 %}'.replace('0', requestId);

            // Add CSRF token to the form
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = '{{ csrf_token }}';
            form.appendChild(csrfToken);

            // Add remark input to the form
            const remarkInput = document.createElement('input');
            remarkInput.type = 'hidden';
            remarkInput.name = 'remark';
            remarkInput.value = remarkText;
            form.appendChild(remarkInput);

            // Append the form to the body and submit it
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Accept request with additional charge
    function acceptRequestWithCharge(requestId) {
        const additionalCharge = document.getElementById('additional-charge-input-' + requestId).value;

        if (additionalCharge.trim() === '') {
            alert('Please enter the additional charge before accepting.');
            return;
        }

        // Confirm acceptance
        if (confirm('Are you sure you want to accept this request with the additional charge?')) {
            // Create a form dynamically to submit the accept request with the additional charge
            const form = document.getElementById('accept-form-' + requestId);

            // Add additional charge to the form as hidden input
            const inputCharge = document.createElement('input');
            inputCharge.type = 'hidden';
            inputCharge.name = 'aamount';
            inputCharge.value = additionalCharge;
            form.appendChild(inputCharge);

            // Now submit the form properly
            form.submit();  
        }
    }
</script>

<style>
    .card {
        background-color: #edeff2; /* Light gray background */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Custom shadow effect */
        transition: transform 0.3s ease, box-shadow 0.3s ease; /* Smooth transition */
    }

    .card:hover {
        transform: translateY(-5px); /* Slightly raise the card on hover */
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Darker shadow on hover */
    }

    .card-body {
        padding: 15px;
    }

    .card-title {
        font-size: 1.1rem; /* Larger title size */
        color: #343a40; /* Darker text for title */
    }

    .card-text {
        color: #495057; /* Slightly darker text for better readability */
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 0.85rem;
    }

    .reject-remark {
        display: none;
    }

    .additional-charge {
        display: none;
    }

    .alert-info {
        font-size: 1.2rem;
        padding: 20px;
    }
</style>

<div class="footer-container">
    {% include "Studio/footer.html" %}
</div>

<style>
    .footer-container {
        position: fixed;
        bottom: 0;
        width: 100%;
    }
</style>
